# M-PESA B2C — Node.js + TypeScript

A minimal **M-PESA B2C sandbox integration** using Node.js, TypeScript, and Vercel serverless functions. Designed for personal use and can be triggered from OpenClaw or other automation tools.

---

## Project Structure

```
mpesa-b2c/
├── api/
│   ├── b2c/
│   │   ├── pay.ts          # Initiates B2C payment
│   │   ├── result.ts       # Result webhook (called by Daraja)
│   │   └── timeout.ts      # Timeout webhook (called by Daraja)
│   └── utils/
│       └── mpesa.ts        # Utility functions for Daraja API calls
├── package.json
├── tsconfig.json
├── vercel.json
├── .env.example
├── .gitignore
└── README.md
```

---

## Setup

### 1. Clone the repository

```bash
git clone https://github.com/Abdullahi254/B2C.git
cd mpesa-b2c
```

### 2. Install dependencies

```bash
pnpm install
```

### 3. Configure environment variables

Copy the example env file and fill in your credentials:

```bash
cp .env.example .env
```

| Variable | Description |
|---|---|
| `MPESA_BASE_URL` | Daraja API base URL (sandbox or production) |
| `MPESA_CONSUMER_KEY` | Your app's consumer key from Safaricom Developer Portal |
| `MPESA_CONSUMER_SECRET` | Your app's consumer secret |
| `MPESA_INITIATOR_NAME` | Initiator username for B2C transactions |
| `MPESA_SECURITY_CREDENTIAL` | Encrypted initiator password |
| `MPESA_SHORTCODE` | Your organization's shortcode |
| `BASE_URL` | Your public callback base URL (e.g. ngrok URL for local dev) |

### 4. Run locally

```bash
vercel dev
```

---

## API Endpoints

| Method | Path | Description |
|---|---|---|
| `POST` | `/api/b2c/pay` | Trigger a B2C payment |
| `POST` | `/api/b2c/result` | Webhook — receives payment result from Daraja |
| `POST` | `/api/b2c/timeout` | Webhook — receives timeout notification from Daraja |

---

## Triggering a Payment

Send a `POST` request to `/api/b2c/pay`:

```json
{
  "phone": "254712345678",
  "amount": 100,
  "remarks": "Test payment"
}
```

---

## Notes

- This project uses the **Safaricom sandbox** by default. To go live, update `MPESA_BASE_URL` and your credentials.
- Your `BASE_URL` must be publicly accessible for Daraja webhooks to reach your local machine. Use [ngrok](https://ngrok.com/) during development.
- The security credential must be generated by encrypting your initiator password with the Safaricom public certificate.

---

## License

MIT
