# M-PESA B2C — Node.js + TypeScript

A minimal **M-PESA B2C sandbox integration** using Node.js, TypeScript, and Vercel serverless functions. Designed for personal use and can be triggered from OpenClaw or other automation tools.

---

## Requirements

- Node.js 18+
- pnpm
- Vercel CLI (must be installed globally)

Install Vercel globally:

```bash
pnpm add -g vercel
```

Verify installation:

```bash
vercel --version
```

---

## Project Structure

```
mpesa-b2c/
├── api/
│   ├── b2c/
│   │   ├── pay.ts          # Initiates B2C payment
│   │   ├── result.ts       # Result webhook (called by Daraja)
│   │   └── timeout.ts      # Timeout webhook (called by Daraja)
│   └── utils/
│       └── mpesa.ts        # Utility functions for Daraja API calls
├── package.json
├── tsconfig.json
├── vercel.json
├── .env.example
├── .gitignore
└── README.md
```

---

## Setup

### 1. Clone the repository

```bash
git clone https://github.com/Abdullahi254/B2C.git
cd B2C
```

### 2. Install dependencies

```bash
pnpm install
```

### 3. Configure environment variables

Copy the example env file and fill in your credentials:

```bash
cp .env.example .env
```

| Variable | Description |
|---|---|
| `MPESA_BASE_URL` | Daraja API base URL (sandbox or production) |
| `MPESA_CONSUMER_KEY` | Consumer key from Safaricom Developer Portal |
| `MPESA_CONSUMER_SECRET` | Consumer secret |
| `MPESA_INITIATOR_NAME` | Initiator username for B2C |
| `MPESA_SECURITY_CREDENTIAL` | Encrypted initiator password |
| `MPESA_SHORTCODE` | Organization shortcode |
| `BASE_URL` | Public callback base URL (e.g. ngrok URL) |

---

## Run Locally

Start the Vercel development server:

```bash
vercel dev
```

Your API will be available at:

```
http://localhost:3000
```

---

## API Endpoints

| Method | Path | Description |
|---|---|---|
| `POST` | `/api/b2c/pay` | Trigger a B2C payment |
| `POST` | `/api/b2c/result` | Webhook — receives payment result |
| `POST` | `/api/b2c/timeout` | Webhook — receives timeout notification |

---

## Triggering a Payment

### Using curl

```bash
curl -X POST http://localhost:3000/api/b2c/pay \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "254712345678",
    "amount": 100,
    "remarks": "Test payment"
  }'
```

---

## Expected Response (Successful Request Submission)

```json
{
  "message": "B2C request sent successfully",
  "ConversationID": "AG_20240706_2010364430d9bbdaf872",
  "OriginatorConversationID": "53e3-4aa8-9fe0-8fb5e4092cdd3533373"
}
```

⚠️ This only means the request was accepted by Daraja.  
The final transaction result will be sent to `/api/b2c/result`.

---

## Testing Webhooks Manually

Simulate a successful callback:

```bash
curl -X POST http://localhost:3000/api/b2c/result \
  -H "Content-Type: application/json" \
  -d '{
    "Result": {
      "ResultCode": 0,
      "ResultDesc": "The service request is processed successfully."
    }
  }'
```

---

## Notes

- This project uses the Safaricom sandbox by default.
- To go live, update `MPESA_BASE_URL` and credentials.
- `BASE_URL` must be publicly accessible for Daraja to send webhooks.
- Use ngrok during local development:

```bash
ngrok http 3000
```

- `MPESA_SECURITY_CREDENTIAL` must be generated by encrypting your initiator password using the Safaricom public certificate.
- Sandbox and Production credentials are different.

---

## License

MIT
